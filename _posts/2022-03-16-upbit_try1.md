---
layout: post
title: "업비트 API 자동거래 테스트4"
subtitle: "session 로그인 구현"
date: 2022-03-16 11:23:10 -0400
background: '/img/posts/node_bg.jpg'
tags: [nodejs]
---

#### 필요기능
* 암호화된 key파일 및 비밀번호/아이디를 통한 local전략 실행
* session 확인할 시 복호화 작업

### ./passport/localStrategy.js
##### 로그인 체크 (단순 객체 )
``` javascript
const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;
const user_box = require('../user');

module.exports = () => {
    passport.use(new LocalStrategy({
        usernameField: 'id',
        passwordField: 'auth_code',
    }, async (id, auth_code, done) => {
        try { 
            const id_chk = user_box.hasOwnProperty(id);
            if(id_chk){
                if(auth_code == user_box[id][1]) {
                    done(null, id);
                }else{
                    done(null, false, { message: '비밀번호가 일치하지 않습니다.' });
                }
            }else{
                done(null, false, { message: '가입되지 않은 회원입니다.' });
            }
        } catch (error){
            console.error(error);
            done(error);
        }
    }));
};
```
<br>

### ./routes/api.js
##### api 라우터 요청 확인 후 class파일 생성하여 요청 API 수행 및 결과값 응답)
``` javascript
//init
const express = require('express');
const cookieParser = require('cookie-parser');
const bodyParser = require('body-parser');
const session = require('express-session');
const nunjucks = require('nunjucks');
const passport = require('passport');
const app = express();
const path = require('path');

//extra init
const { urlencoded } = require('express');
const pageRouter = require('./routes/page');
const apiRouter = require('./routes/api');
const authRouter = require('./routes/auth');
const passportConfig = require('./passport');
passportConfig();

//set
app.set('port', process.env.PORT || 7002);
app.set('view engine', 'html');
nunjucks.configure('views', {
    express :app,
    watch: true,
});

//middleware
app.use(bodyParser.json());
app.use(express.static('public'));
app.use(express.static(path.join(__dirname,'public')));
app.use(urlencoded({ extended: false }));
app.use(cookieParser('locked'));
app.use(session({
    resave: false,
    saveUninitialized: false,
    secret: 'locked',
    cookie: {
        httpOnly:true,
        secure: false,
    },
}));
app.use(passport.initialize());
app.use(passport.session());

//route
app.use('/', pageRouter);
app.use('/auth', authRouter);
app.use('/api', apiRouter);

//error
app.use((req, res, next) => {
    const error = new Error(`${req.method} ${req.url} 라우터가 없습니다.`);
    error.status = 404;
    next(error);
});
app.use((err, req, res, next) => {
    res.locals.message = err.message;
    res.locals.error = err;
    res.status(err.status || 500);
    res.render('error');
});

//chk
app.listen(app.get('port'), () => {
    console.log(app.get('port'), '번 포트에서 대기 중');
});
```
<br>
<img style="border: solid grey 2px;" src="/img/work/upbit_login.png" width="30%" height="30%"> 	
#### 로그인화면
